machine:
  services:
    - mysql
    - cassandra
    - elasticsearch
  java:
    version: openjdk8
  post:
    - curl -SL http://www.us.apache.org/dist/kafka/0.8.2.2/kafka_2.11-0.8.2.2.tgz | tar xz
    - ./kafka_*/bin/kafka-server-start.sh ./kafka_*/config/server.properties:
        background: true

dependencies:
  pre:
    - sudo apt-get update; sudo apt-get install zookeeperd
  override:
    - MYSQL_USER=ubuntu ./mvnw install -nsu

database:
  override:
    - mysql -u ubuntu -e 'SET GLOBAL innodb_file_format=Barracuda'
    - mysql -u ubuntu -e 'create database if not exists zipkin'
    - mysql -u ubuntu -Dzipkin < zipkin-storage/mysql/src/main/resources/mysql.sql

test:
  post:
    - mkdir -p $CIRCLE_TEST_REPORTS/junit/
    - find . -type f -regex ".*/target/surefire-reports/.*xml" -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;
